---
import site from "../content/site.json";

const siteName = site.clinic_name || site.name || "Cl√≠nica Dr. V√≠ctor Miranda";
const initials = site.initials || "VM";

const {
  title = siteName,
  description = "Medicina est√©tica con enfoque en seguridad y resultados naturales.",
} = Astro.props;

const year = new Date().getFullYear();

// Colores
const accent = String(site.accent_color || "#0F766E").trim();
const accent2 = String(site.accent_color_2 || "#06B6D4").trim();

// Fondo + ancho + separaci√≥n
const bg = String(site.bg_color || "#ffffff").trim();
const maxWidth = String(site.max_width || "1120px").trim();
const navLinksGap = String(site.nav_links_gap || "16px").trim();

// Espacios home
const homeGapServicesComplications = String(site.home_gap_services_complications || "64px").trim();
const homeGapCoverServices = String(site.home_gap_cover_services || "48px").trim();
const homeGapComplicationsSocial = String(site.home_gap_complications_social || "64px").trim();
const homeGapSocialFooter = String(site.home_gap_social_footer || "56px").trim();

// WhatsApp
const whatsappNumber = String(site.whatsapp || "").replace(/\D/g, "");
const whatsappLink = `https://wa.me/${whatsappNumber}`;

// Booking
const bookingUrl = String(site.booking_url || "").trim() || "/contacto/";

// Logo
const logoImage = String(site.logo_image || "").trim();

// Footer
const footerClinicName = site.footer?.clinic_name || site.clinic_name || site.name || siteName;
const footerCity = site.footer?.city || site.city || "";
const footerEmail = site.footer?.email || site.email || "";
const footerPoliciesLabel = site.footer?.policies_label || "Pol√≠ticas";
const footerPoliciesUrl = site.footer?.policies_url || "/politicas";

// Navbar desde Admin (fallback)
const defaultNavbarItems = [
  {
    label: "Tratamientos m√©dicos",
    href: "/tratamientos-medicos/",
    mega: {
      groups: [
        {
          title: "Medicina est√©tica facial",
          links: [
            { label: "Full Face", href: "/tratamientos-medicos/full-face/" },
            { label: "Tri√°ngulo invertido", href: "/tratamientos-medicos/triangulo-invertido/" },
            { label: "Bruxismo", href: "/tratamientos-medicos/bruxismo/" }
          ]
        },
        {
          title: " ",
          links: [
            { label: "Labios", href: "/tratamientos-medicos/labios/" },
            { label: "Relleno de ojeras", href: "/tratamientos-medicos/ojeras/" },
            { label: "Rinomodelaci√≥n", href: "/tratamientos-medicos/rinomodelacion/" }
          ]
        },
        {
          title: "Medicina est√©tica corporal",
          links: [
            { label: "Intralipoterapia", href: "/tratamientos-medicos/intralipoterapia/" },
            { label: "Hiperhidrosis", href: "/tratamientos-medicos/hiperhidrosis/" },
            { label: "Mesoterapia", href: "/tratamientos-medicos/mesoterapia/" }
          ]
        }
      ]
    }
  },
  {
    label: "Packs",
    href: "/packs/",
    children: [{ label: "Ver packs", href: "/packs/" }]
  },
  {
    label: "Tienda",
    href: "/tienda/",
    children: [{ label: "Ver tienda", href: "/tienda/" }]
  },
  {
    label: "Tarjeta de regalo",
    href: "/tarjeta-de-regalo/",
    children: [{ label: "Comprar", href: "/tarjeta-de-regalo/" }]
  },
  {
    label: "Blog de belleza",
    href: "/blog/",
    children: [{ label: "Ver blog", href: "/blog/" }]
  },
  {
    label: "Contacto",
    href: "/contacto/",
    children: [{ label: "Cont√°ctanos", href: "/contacto/" }]
  },
  {
    label: "Rebon",
    href: "/rebon/",
    children: [{ label: "Conocer", href: "/rebon/" }]
  }
];

const navbarItems =
  Array.isArray(site?.navbar?.items) && site.navbar.items.length ? site.navbar.items : defaultNavbarItems;
---

<!doctype html>
<html
  lang="es"
  style={`--bg:${bg};--max:${maxWidth};--nav-gap:${navLinksGap};--home-gap-sc:${homeGapServicesComplications};--home-gap-cs:${homeGapCoverServices};--home-gap-ccs:${homeGapComplicationsSocial};--home-gap-sf:${homeGapSocialFooter};--accent:${accent};--accent2:${accent2};`}
>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />

    <style>
      :root{
        --bg: #ffffff;
        --max: 1120px;
        --nav-gap: 16px;
        --accent: #0F766E;
        --accent2: #06B6D4;

        --home-gap-sc: 64px;
        --home-gap-cs: 48px;
        --home-gap-ccs: 64px;
        --home-gap-sf: 56px;

        --text: #0f172a;
        --muted: #475569;
        --line: #e2e8f0;
      }

      *{ box-sizing:border-box; }
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color:var(--text);
        background: var(--bg);
        line-height:1.55;
      }
      a{ color: inherit; text-decoration: none; }
      .container{ max-width: var(--max); margin:0 auto; padding: 18px; }

      /* Header (se esconde al bajar) */
      .header{
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(255,255,255,.78);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(15,23,42,.10);
        transition: transform 220ms ease, background 180ms ease;
        will-change: transform;
      }
      .header.is-hidden{ transform: translateY(-110%); }

      /* Fila superior */
      .nav-top{
        display:grid;
        grid-template-columns: 1fr auto 1fr;
        align-items:center;
        gap: 14px;
        padding: 14px 0 8px;
      }
      .top-left{ justify-self:start; }
      .top-center{ justify-self:center; }
      .top-right{ justify-self:end; display:flex; gap:10px; align-items:center; }

      /* Logo */
      .brand{
        display:flex;
        flex-direction: column;
        align-items:center;
        gap: 8px;
        font-weight: 900;
        letter-spacing: .2px;
        text-align:center;
      }
      .brand-badge{
        width: 56px;
        height: 56px;
        border-radius: 18px;
        background:
          radial-gradient(100px 50px at 20% 10%, var(--accent2), rgba(255,255,255,0)),
          linear-gradient(135deg, var(--accent), #0f172a);
        color: #fff;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow: 0 14px 30px rgba(15,23,42,0.18);
        overflow: hidden;
        flex: 0 0 auto;
      }
      .brand-badge img{ width:100%; height:100%; object-fit:cover; display:block; }
      .brand-name{ font-weight: 900; font-size: 16px; letter-spacing: .02em; white-space: nowrap; }

      /* Botones */
      .btn{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:10px;
        padding: 12px 16px;
        border-radius: 16px;
        border: 1px solid rgba(15,23,42,.12);
        background: rgba(255,255,255,.95);
        color: rgba(15,23,42,.92);
        font-weight: 900;
        box-shadow: 0 10px 24px rgba(15,23,42,0.05);
        white-space: nowrap;
      }
      .btn:hover{ background: rgba(15,23,42,.05); }
      .btn-primary{
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        border: none;
        color: #fff;
        box-shadow: 0 14px 30px rgba(6,182,212,0.18);
      }
      .btn-primary:hover{ filter: brightness(.97); }

      /* Fila inferior: men√∫ */
      .nav-bottom{
        position: relative;
        padding: 8px 0 12px;
      }
      .nav-menu{
        width: 100%;
        display:flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        align-items:center;
        justify-content: space-between;
        gap: var(--nav-gap);
      }

      /* Dropdown base */
      details.dd{ position: relative; flex: 0 0 auto; }
      details.dd > summary{
        list-style:none;
        cursor:pointer;
        padding: 10px 10px;
        border-radius: 12px;
        color: rgba(15,23,42,.78);
        font-weight: 900;
        font-size: 12px;
        letter-spacing: .06em;
        text-transform: uppercase;
        user-select: none;
        display:flex;
        align-items:center;
        gap: 6px;
        white-space: nowrap;
      }
      details.dd > summary::-webkit-details-marker{ display:none; }
      details.dd > summary:hover{
        background: rgba(15,23,42,.06);
        color: rgba(15,23,42,.92);
      }
      .caret{ font-size: 12px; opacity:.7; }

      /* Panel normal */
      .dd-panel{
        position:absolute;
        top: calc(100% + 10px);
        left: 0;
        min-width: 240px;
        max-width: min(360px, 75vw);
        background: rgba(255,255,255,.98);
        border: 1px solid rgba(15,23,42,.10);
        border-radius: 16px;
        padding: 10px;
        box-shadow: 0 16px 40px rgba(2,6,23,.12);
        z-index: 60;

        opacity: 0;
        transform: translateY(-8px);
        pointer-events: none;
        transition: opacity 180ms ease, transform 180ms ease;
      }
      details.dd[open] > .dd-panel{
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }
      details.dd.closing > .dd-panel{
        opacity: 0;
        transform: translateY(-8px);
        pointer-events: none;
      }

      .dd-main{
        display:block;
        padding: 10px 10px;
        border-radius: 12px;
        font-weight: 900;
        border: 1px solid rgba(15,23,42,.10);
        background: rgba(15,23,42,.02);
        margin-bottom: 8px;
      }
      .dd-main:hover{ background: rgba(15,23,42,.06); }

      .dd-item{
        display:block;
        padding: 10px 10px;
        border-radius: 12px;
        border: 1px solid rgba(15,23,42,.08);
        background: rgba(255,255,255,.9);
        font-weight: 800;
      }
      .dd-item:hover{ background: rgba(15,23,42,.05); }

      /* ===== Mega men√∫ (horizontal en columnas) ===== */
      .mega-panel{
        position:absolute;
        top: calc(100% + 12px);
        left: 50%;
        transform: translateX(-50%) translateY(-10px);
        width: min(var(--max), calc(100vw - 36px));
        background: rgba(255,255,255,.98);
        border: 1px solid rgba(15,23,42,.10);
        border-radius: 18px;
        box-shadow: 0 18px 52px rgba(2,6,23,.16);
        z-index: 80;
        padding: 18px;

        opacity: 0;
        pointer-events: none;
        transition: opacity 190ms ease, transform 190ms ease;
      }
      details.dd[open] > .mega-panel{
        opacity: 1;
        pointer-events: auto;
        transform: translateX(-50%) translateY(0);
      }
      details.dd.closing > .mega-panel{
        opacity: 0;
        pointer-events: none;
        transform: translateX(-50%) translateY(-10px);
      }

      .mega-grid{
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 18px 26px;
        align-items:start;
      }

      .mega-title{
        font-weight: 900;
        font-size: 12px;
        letter-spacing: .10em;
        text-transform: uppercase;
        color: rgba(15,23,42,.55);
        margin: 0 0 10px;
      }

      .mega-link{
        display:block;
        padding: 9px 10px;
        border-radius: 12px;
        font-weight: 800;
        color: rgba(15,23,42,.80);
        border: 1px solid rgba(15,23,42,.06);
        background: rgba(15,23,42,.02);
        margin-bottom: 8px;
      }
      .mega-link:hover{
        background: rgba(15,23,42,.06);
        color: rgba(15,23,42,.95);
      }

      /* ===== Men√∫ m√≥vil (hamburguesa) ===== */
      .nav-mobile{ display:none !important; position: relative; }
      .burger{
        list-style:none;
        cursor:pointer;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(15,23,42,.12);
        background: rgba(255,255,255,.92);
        font-weight: 900;
        user-select: none;
      }
      .burger::-webkit-details-marker{ display:none; }

      details.nav-mobile:not([open]) .mobile-panel{ display:none; }
      details.nav-mobile[open] .mobile-panel{ display:flex; }

      .mobile-panel{
        position:absolute;
        right: 0;
        top: calc(100% + 10px);
        width: min(380px, 92vw);
        background: rgba(255,255,255,.98);
        border: 1px solid rgba(15,23,42,.10);
        border-radius: 18px;
        padding: 12px;
        box-shadow: 0 16px 40px rgba(2,6,23,.12);
        flex-direction: column;
        gap: 10px;
        z-index: 90;
      }

      .m-home{
        display:flex;
        justify-content:center;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid rgba(15,23,42,.10);
        background: rgba(15,23,42,.02);
        font-weight: 900;
      }

      details.mdd > summary{
        list-style:none;
        cursor:pointer;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid rgba(15,23,42,.10);
        background: rgba(255,255,255,.92);
        font-weight: 900;
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 10px;
      }
      details.mdd > summary::-webkit-details-marker{ display:none; }

      .mdd-panel{
        display:flex;
        flex-direction: column;
        gap: 8px;
        padding: 10px 0 0 0;
      }
      .mdd-panel a{
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid rgba(15,23,42,.08);
        background: rgba(15,23,42,.02);
        font-weight: 800;
      }

      .m-group-title{
        font-size: 12px;
        font-weight: 900;
        letter-spacing: .08em;
        text-transform: uppercase;
        opacity: .6;
        margin-top: 8px;
      }

      .mobile-cta{ display:flex; gap:10px; }
      .mobile-cta .btn{ flex:1; }

      @media (max-width: 860px){
        .container{ padding: 14px; }
        .nav-bottom{ display:none !important; }
        .top-right .btn{ display:none !important; }
        .nav-mobile{ display:block !important; }

        .nav-top{ padding: 10px 0 10px; }
        .brand{ flex-direction: row; gap: 10px; }
        .brand-badge{ width: 42px; height: 42px; border-radius: 14px; }
        .brand-name{
          font-size: 14px;
          max-width: 210px;
          overflow: hidden;
          text-overflow: ellipsis;
        }
      }

      /* Footer */
      .site-footer{
        margin-top: var(--home-gap-sf);
        border-top: 1px solid var(--line);
        padding: 26px 0;
      }
      .footer-inner{
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
        color: var(--muted);
      }
      .footer-brand{ color: var(--text); font-weight: 800; letter-spacing: .2px; }
      .footer-heading{ font-size: 12px; opacity: .65; margin-bottom: 6px; }
      @media (min-width: 768px){
        .footer-inner{ grid-template-columns: 1fr 1fr 1fr; gap: 24px; align-items: start; }
        .footer-center{ text-align: center; }
        .footer-right{ text-align: right; }
      }

      /* WhatsApp flotante */
      .wa-fab{
        position: fixed !important;
        right: 18px !important;
        bottom: 18px !important;
        z-index: 2147483647 !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 10px !important;
        padding: 12px 14px !important;
        border-radius: 999px !important;
        background: #25D366 !important;
        color: #fff !important;
        font-weight: 900 !important;
        box-shadow: 0 14px 30px rgba(0,0,0,0.18) !important;
      }
    </style>
  </head>

  <body>
    <header class="header">
      <div class="container">

        <!-- FILA 1 -->
        <div class="nav-top" aria-label="Barra superior">
          <div class="top-left"></div>

          <div class="top-center">
            <a class="brand" href="/" aria-label={siteName}>
              <span class="brand-badge">
                {logoImage ? <img src={logoImage} alt="Logo" /> : initials}
              </span>
              <span class="brand-name">{siteName}</span>
            </a>
          </div>

          <div class="top-right">
            <a class="btn" href={whatsappLink} target="_blank" rel="noreferrer">üí¨ WhatsApp</a>
            <a class="btn btn-primary" href={bookingUrl} target="_blank" rel="noreferrer">Pide tu cita</a>

            <!-- Burger (solo tel√©fono) -->
            <details class="nav-mobile">
              <summary class="burger" aria-label="Abrir men√∫">‚ò∞</summary>
              <div class="mobile-panel">
                <a class="m-home" href="/">Inicio</a>

                {navbarItems.map((item) => (
                  <details class="mdd">
                    <summary>
                      <span>{item.label}</span>
                      <span class="caret">‚ñæ</span>
                    </summary>

                    <div class="mdd-panel">
                      <a href={item.href}>Ver secci√≥n</a>

                      {item?.mega?.groups?.length ? (
                        item.mega.groups.map((g) => (
                          <>
                            <div class="m-group-title">{g.title}</div>
                            {Array.isArray(g.links) ? g.links.map((lnk) => (
                              <a href={lnk.href}>{lnk.label}</a>
                            )) : null}
                          </>
                        ))
                      ) : Array.isArray(item.children) && item.children.length ? (
                        item.children.map((c) => (
                          <a href={c.href}>{c.label}</a>
                        ))
                      ) : null}
                    </div>
                  </details>
                ))}

                <div class="mobile-cta">
                  <a class="btn" href={whatsappLink} target="_blank" rel="noreferrer">üí¨ WhatsApp</a>
                  <a class="btn btn-primary" href={bookingUrl} target="_blank" rel="noreferrer">Pide tu cita</a>
                </div>
              </div>
            </details>
          </div>
        </div>

        <!-- FILA 2 (DESKTOP) -->
        <div class="nav-bottom" aria-label="Men√∫ principal">
          <div class="nav-menu">
            {navbarItems.map((item) => {
              const isMega = !!(item?.mega?.groups && Array.isArray(item.mega.groups) && item.mega.groups.length);

              return (
                <details class="dd">
                  <summary>
                    {item.label} <span class="caret">‚ñæ</span>
                  </summary>

                  {isMega ? (
                    <div class="mega-panel" role="menu">
                      <div class="mega-grid">
                        {item.mega.groups.map((g) => (
                          <div>
                            <div class="mega-title">{g.title}</div>
                            {Array.isArray(g.links) && g.links.length ? (
                              g.links.map((lnk) => (
                                <a class="mega-link" href={lnk.href} role="menuitem">{lnk.label}</a>
                              ))
                            ) : (
                              <a class="mega-link" href={item.href} role="menuitem">Ver secci√≥n</a>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  ) : (
                    <div class="dd-panel" role="menu">
                      <a class="dd-main" href={item.href} role="menuitem">Ver secci√≥n</a>
                      {Array.isArray(item.children) && item.children.length ? (
                        item.children.map((c) => (
                          <a class="dd-item" href={c.href} role="menuitem">{c.label}</a>
                        ))
                      ) : (
                        <span class="dd-empty">Pr√≥ximamente</span>
                      )}
                    </div>
                  )}
                </details>
              );
            })}
          </div>
        </div>

      </div>
    </header>

    <main>
      <div class="container">
        <slot />
      </div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <div class="footer-inner">
          <div class="footer-col footer-left">
            <div class="footer-brand">{footerClinicName}</div>
          </div>

          <div class="footer-col footer-center">
            <div class="footer-heading">Ubicaci√≥n</div>
            <div class="footer-text">{footerCity}</div>
          </div>

          <div class="footer-col footer-right">
            <div class="footer-heading">Contacto</div>

            {footerEmail ? (
              <a class="footer-link" href={`mailto:${footerEmail}`}>
                {footerEmail}
              </a>
            ) : null}

            <div style="height:6px;"></div>

            <a class="footer-link" href={footerPoliciesUrl}>
              {footerPoliciesLabel}
            </a>
          </div>
        </div>

        <div style="height:10px;"></div>
        <small style="color:var(--muted);opacity:.8;">
          ¬© {year} ¬∑ {siteName}
        </small>
      </div>
    </footer>

    <a class="wa-fab" href={whatsappLink} target="_blank" rel="noreferrer" aria-label="WhatsApp">
      üí¨ WhatsApp
    </a>

    <script is:inline>
      // ===== Dropdown suave (abre/cierra con animaci√≥n) + hover desktop =====
      (() => {
        const prefersReduce = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        if (prefersReduce) return;

        const isDesktop = () => window.matchMedia("(min-width: 861px)").matches;
        const dds = Array.from(document.querySelectorAll("details.dd"));
        if (!dds.length) return;

        const closeWithAnim = (d) => {
          if (!d.open) return;
          if (d.classList.contains("closing")) return;
          d.classList.add("closing");
          setTimeout(() => {
            d.removeAttribute("open");
            d.classList.remove("closing");
          }, 170);
        };

        const closeOthers = (current) => {
          dds.forEach((o) => {
            if (o !== current && o.open) closeWithAnim(o);
          });
        };

        // Click: cerrar suave
        dds.forEach((d) => {
          const summary = d.querySelector("summary");
          if (!summary) return;

          summary.addEventListener("click", (e) => {
            if (!isDesktop()) return;
            if (d.open) {
              e.preventDefault();
              closeWithAnim(d);
            } else {
              closeOthers(d);
              // abrir normal
            }
          });

          // Hover desktop (tipo referencia)
          d.addEventListener("mouseenter", () => {
            if (!isDesktop()) return;
            closeOthers(d);
            d.setAttribute("open", "");
          });

          d.addEventListener("mouseleave", () => {
            if (!isDesktop()) return;
            closeWithAnim(d);
          });
        });

        // Click fuera
        document.addEventListener("click", (e) => {
          dds.forEach((d) => {
            if (d.open && !d.contains(e.target)) closeWithAnim(d);
          });
        });
      })();

      // ===== Ocultar header al bajar / mostrar al subir =====
      (() => {
        const header = document.querySelector(".header");
        if (!header) return;

        const reduceMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        if (reduceMotion) return;

        let lastY = window.scrollY;
        let hidden = false;

        const isMobileMenuOpen = () => {
          const mob = document.querySelector(".nav-mobile");
          return mob && mob.hasAttribute("open");
        };

        window.addEventListener("scroll", () => {
          const y = window.scrollY;

          if (isMobileMenuOpen()) {
            header.classList.remove("is-hidden");
            hidden = false;
            lastY = y;
            return;
          }

          if (y < 40) {
            header.classList.remove("is-hidden");
            hidden = false;
            lastY = y;
            return;
          }

          const goingDown = y > lastY;

          if (goingDown && !hidden && y > 120) {
            header.classList.add("is-hidden");
            hidden = true;
          } else if (!goingDown && hidden) {
            header.classList.remove("is-hidden");
            hidden = false;
          }

          lastY = y;
        }, { passive: true });
      })();
    </script>
  </body>
</html>
