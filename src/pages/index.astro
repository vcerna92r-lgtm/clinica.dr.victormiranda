---
import BaseLayout from "../layouts/BaseLayout.astro";
import site from "../content/site.json";
import home from "../content/home.json";
import homeServices from "../content/home_services.json";
import complications from "../content/home_complications.json";
import social from "../content/home_social.json";

const siteName = site.clinic_name || site.name || "Clínica Dr. Víctor Miranda";
const bookingUrl = String(site.booking_url || "").trim() || "/contacto/";

const whatsappNum = String(site.whatsapp || "").trim();
const whatsappMessage = encodeURIComponent(String(site.whatsapp_message || "").trim() || "Hola, quiero agendar una valoración.");
const whatsappUrl = whatsappNum ? `https://wa.me/${whatsappNum}?text=${whatsappMessage}` : "https://wa.me/50587355501";

function resolveImageSrc(src) {
  let s = String(src || "").trim();
  if (!s) return "";
  if (s.startsWith("http://") || s.startsWith("https://")) return s;
  if (s.startsWith("public/")) s = s.replace(/^public\//, "");
  if (!s.startsWith("/")) s = `/${s}`;
  return s;
}

function resolveUrl(url, fallback) {
  const u = String(url || "").trim();
  return u ? u : fallback;
}

function fontClass(v) {
  return String(v || "system") === "serif" ? "font-serif" : "font-system";
}
function titleSizeClass(v) {
  const s = String(v || "xl");
  if (s === "md") return "title-md";
  if (s === "lg") return "title-lg";
  return "title-xl";
}
function textSizeClass(v) {
  const s = String(v || "md");
  if (s === "sm") return "text-sm";
  if (s === "lg") return "text-lg";
  return "text-md";
}

/* Servicios principales */
function shapeClass(shape) {
  const s = String(shape || "rounded").toLowerCase();
  if (s === "circle") return "hs-shape-circle";
  if (s === "square") return "hs-shape-square";
  return "hs-shape-rounded";
}

/* Redes sociales */
function socialShapeClass(shape) {
  const s = String(shape || "rounded").toLowerCase();
  if (s === "circle") return "ss-shape-circle";
  if (s === "square") return "ss-shape-square";
  return "ss-shape-rounded";
}

/* Complicaciones */
function compShapeClass(shape) {
  const s = String(shape || "rounded").toLowerCase();
  if (s === "circle") return "comp-shape-circle";
  if (s === "square") return "comp-shape-square";
  return "comp-shape-rounded";
}
function compRatioClass(ratio) {
  const r = String(ratio || "landscape").toLowerCase();
  if (r === "portrait") return "comp-ratio-portrait";
  if (r === "square") return "comp-ratio-square";
  return "comp-ratio-landscape";
}

const marqueeOn = complications.marquee_enabled !== false;
const marqueeBase = String(complications.marquee_text || complications.title || "Manejo de complicaciones").trim();
const marqueeRepeat = Array(8).fill(marqueeBase).join(" ✶ ") + " ✶ ";
const marqueeSpeed = String(complications.marquee_speed || "normal");
const marqueeDuration = marqueeSpeed === "fast" ? 12 : marqueeSpeed === "slow" ? 28 : 18;

const compAlign = String(complications.text_align || "left");
const compBold = !!complications.text_bold;
const compItalic = !!complications.text_italic;
---

<BaseLayout
  title={`${siteName} | Medicina estética`}
  description="Tratamientos personalizados con enfoque en seguridad, naturalidad y seguimiento clínico."
>
  <!-- PORTADA -->
  <section class="cover">
    <div class="cover-grid">
      <div class="cover-photo">
        {home.hero_image ? (
          <img src={resolveImageSrc(home.hero_image)} alt={home.hero_title || siteName} loading="lazy" />
        ) : (
          <div class="photo-placeholder" aria-hidden="true"></div>
        )}
      </div>

      <div class={`cover-copy ${fontClass(home.hero_font_family)} ${textSizeClass(home.hero_text_size)}`}>
        <h1 class={titleSizeClass(home.hero_title_size)}>{home.hero_title || "Tu nombre"}</h1>

        {home.hero_bullets?.length ? (
          <ul class="bullets">
            {home.hero_bullets.map((b) => <li>{b.text}</li>)}
          </ul>
        ) : null}

        {home.hero_paragraphs?.map((p) => <p class="para">{p.text}</p>)}
      </div>
    </div>
  </section>

  <!-- ✅ Espacio graduable desde /admin: Portada -> Servicios principales -->
  <div class="gap-cover-services" aria-hidden="true"></div>

  <!-- Servicios principales -->
  <section class="section">
    <div class="section-title">
      <div>
        <h2>{homeServices.section_title || "Servicios principales"}</h2>
        {homeServices.section_subtitle && <p class="sub">{homeServices.section_subtitle}</p>}
      </div>
      <a class="link" href="/servicios/">Ver todos →</a>
    </div>

    <div class="home-services-grid">
      {homeServices.items?.map((item) => (
        <article class="home-service-card">
          <div class={`home-service-media ${shapeClass(item.image_shape)}`}>
            {item.image ? (
              <img src={resolveImageSrc(item.image)} alt={item.name || "Servicio"} loading="lazy" />
            ) : (
              <div class="media-placeholder" aria-hidden="true"></div>
            )}
          </div>

          <div class="home-service-body">
            <h3>{item.name}</h3>
            {item.description && <p>{item.description}</p>}
          </div>
        </article>
      ))}
    </div>
  </section>

  <!-- ✅ Espacio graduable desde /admin: Servicios principales -> Manejo de complicaciones -->
  <div class="gap-services-complications" aria-hidden="true"></div>

  <!-- Manejo de complicaciones: estilo video + imagen derecha -->
  <section class="section">
    {marqueeOn ? (
      <div class="comp-marquee" style={`--marqueeDuration:${marqueeDuration}s`}>
        <div class="comp-marquee-track" aria-hidden="true">
          <div class="comp-marquee-seq">{marqueeRepeat}</div>
          <div class="comp-marquee-seq" aria-hidden="true">{marqueeRepeat}</div>
        </div>
      </div>
    ) : null}

    <div class="comp-grid">
      <div
        class={`comp-left ${fontClass(complications.font_family)} ${textSizeClass(complications.text_size)} ${compBold ? "comp-bold" : ""} ${compItalic ? "comp-italic" : ""}`}
        style={`text-align:${compAlign};`}
      >
        {complications.eyebrow && <div class="comp-eyebrow">{complications.eyebrow}</div>}
        <h2 class="comp-title">{complications.title || "Manejo de complicaciones"}</h2>
        {complications.subtitle && <p class="comp-sub">{complications.subtitle}</p>}

        {complications.bullets?.length ? (
          <div class="comp-bullets">
            {complications.bullets_title && <div class="comp-bullets-title">{complications.bullets_title}</div>}
            <ul class="comp-bullets-list">
              {complications.bullets.map((it) => <li>{it.text}</li>)}
            </ul>
          </div>
        ) : null}

        <div class="price-card">
          <div class="price-head">
            <div>
              <div class="plan-name">{complications.plan?.name || "Evaluación de complicaciones"}</div>
              <div class="plan-price">{complications.plan?.price || "$0.00"}</div>
              {complications.plan?.period && <div class="plan-period">{complications.plan.period}</div>}
            </div>

            <a class="plan-btn" href={resolveUrl(complications.plan?.cta_url, bookingUrl)} target="_blank" rel="noreferrer">
              {complications.plan?.cta_text || "Solicitar evaluación"}
            </a>
          </div>

          {complications.includes?.length ? (
            <div class="price-includes">
              <div class="includes-title">{complications.includes_title || "Incluye"}</div>
              <ul class="includes-list">
                {complications.includes.map((it) => <li>{it.text}</li>)}
              </ul>
            </div>
          ) : null}
        </div>

        <div class="comp-box">
          {complications.box_title && <strong>{complications.box_title}</strong>}
          {complications.box_text && <p>{complications.box_text}</p>}

          {complications.box_bullets?.length ? (
            <ul class="comp-box-bullets">
              {complications.box_bullets.map((it) => <li>{it.text}</li>)}
            </ul>
          ) : null}
        </div>
      </div>

      <div class={`comp-right ${compShapeClass(complications.image_shape)} ${compRatioClass(complications.image_ratio)}`}>
        {complications.image ? (
          <img src={resolveImageSrc(complications.image)} alt={complications.title || "Manejo de complicaciones"} loading="lazy" />
        ) : (
          <div class="comp-placeholder" aria-hidden="true"></div>
        )}
      </div>
    </div>
  </section>

  <!-- ✅ NUEVO: Espacio graduable desde /admin: Complicaciones -> Redes -->
  <div class="gap-complications-social" aria-hidden="true"></div>

  <!-- Redes sociales (como la imagen) -->
  <section class="section social">
    <div class="section-title">
      <div>
        <h2>{social.section_title || "Síguenos en redes sociales"}</h2>
        {social.section_subtitle && <p class="sub">{social.section_subtitle}</p>}
      </div>
    </div>

    <div class="social-grid">
      {social.items?.map((it) => (
        <a class="social-card" href={resolveUrl(it.url, "#")} target="_blank" rel="noreferrer" aria-label={it.name || "Red social"}>
          <div class={`social-media ${socialShapeClass(it.image_shape)}`}>
            {it.image ? (
              <img src={resolveImageSrc(it.image)} alt={it.name || "Red social"} loading="lazy" />
            ) : (
              <div class="media-placeholder" aria-hidden="true"></div>
            )}
          </div>
        </a>
      ))}
    </div>

    {(social.button_text || social.button_url) ? (
      <div class="social-cta">
        <a class="social-btn" href={resolveUrl(social.button_url, "#")} target="_blank" rel="noreferrer">
          {social.button_text || "SOCIAL"}
        </a>
      </div>
    ) : null}
  </section>

  <style>
    /* PORTADA */
    .cover{ padding-top: 26px; padding-bottom: 10px; }
    .cover-grid{ display: grid; grid-template-columns: 0.95fr 1.05fr; gap: 22px; align-items: center; }
    .cover-photo{
      width: min(560px, 78vw);
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255,255,255,0.35);
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 16px 40px rgba(15,23,42,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cover-photo img{ width: 100%; height: 100%; object-fit: cover; display:block; }
    .photo-placeholder{
      width: 100%;
      height: 100%;
      background:
        radial-gradient(500px 240px at 20% 20%, rgba(255,255,255,0.70), rgba(255,255,255,0)),
        linear-gradient(135deg, rgba(255,255,255,0.55), rgba(0,0,0,0.05));
      border: 1px dashed rgba(0,0,0,0.12);
    }
    .font-system{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .font-serif{ font-family: ui-serif, Georgia, "Times New Roman", Times, serif; }
    .title-xl{ font-size: 44px; letter-spacing: -0.6px; margin: 0 0 10px; line-height: 1.05; }
    .title-lg{ font-size: 38px; letter-spacing: -0.5px; margin: 0 0 10px; line-height: 1.1; }
    .title-md{ font-size: 32px; letter-spacing: -0.4px; margin: 0 0 10px; line-height: 1.15; }
    .text-lg{ font-size: 18px; }
    .text-md{ font-size: 16px; }
    .text-sm{ font-size: 14px; }
    .bullets{ margin: 0 0 12px; padding-left: 18px; line-height: 1.6; }
    .para{ margin: 10px 0 0; line-height: 1.65; opacity: 0.92; }
    @media (max-width: 980px){
      .cover-grid{ grid-template-columns: 1fr; }
      .cover-photo{ width: min(520px, 85vw); margin: 0 auto; }
    }

    /* ✅ Espacio graduable: Portada -> Servicios */
    .gap-cover-services{ height: var(--home-gap-cs, 48px); }

    /* ✅ Espacio graduable: Servicios -> Complicaciones */
    .gap-services-complications{ height: var(--home-gap-sc, 64px); }

    /* ✅ NUEVO: Espacio graduable: Complicaciones -> Redes */
    .gap-complications-social{ height: var(--home-gap-ccs, 64px); }

    /* Servicios principales */
    .home-services-grid{ display: grid; gap: 18px; grid-template-columns: repeat(12, 1fr); }
    .home-service-card{
      grid-column: span 4;
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 16px 40px rgba(15,23,42,0.06);
      background: #F5F5F2;
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }
    .home-service-media{
      width: 100%;
      aspect-ratio: 16 / 10;
      overflow: hidden;
      padding: 14px;
      background: rgba(255,255,255,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .home-service-media img{ width: 100%; height: 100%; object-fit: cover; border-radius: 16px; display: block; }
    .home-service-body{ padding: 14px 16px 16px; display:flex; flex-direction: column; gap: 8px; }
    .home-service-body h3{ margin: 0; font-size: 18px; letter-spacing: -0.2px; }
    .home-service-body p{ margin: 0; line-height: 1.5; opacity: 0.9; }
    .home-service-media .media-placeholder{ width: 100%; height: 100%; border-radius: 16px; }
    .home-service-media.hs-shape-square img, .home-service-media.hs-shape-square .media-placeholder{ border-radius: 0; }
    .home-service-media.hs-shape-rounded img, .home-service-media.hs-shape-rounded .media-placeholder{ border-radius: 16px; }
    .home-service-media.hs-shape-circle{ aspect-ratio: 1 / 1; padding: 18px; }
    .home-service-media.hs-shape-circle img, .home-service-media.hs-shape-circle .media-placeholder{ border-radius: 999px; }
    @media (max-width: 980px){ .home-service-card{ grid-column: span 6; } }
    @media (max-width: 640px){ .home-service-card{ grid-column: span 12; } }

    /* Redes sociales */
    .social{ margin-bottom: 64px; }
    .social-grid{
      display:flex;
      gap: 18px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      margin-top: 14px;
    }
    .social-card{ display:block; width: min(220px, 90vw); }
    .social-media{
      width: 100%;
      aspect-ratio: 4 / 3;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 16px 40px rgba(15,23,42,0.06);
      background: rgba(255,255,255,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .social-media img{ width: 100%; height: 100%; object-fit: cover; display:block; }
    .social-media.ss-shape-rounded{ border-radius: 18px; }
    .social-media.ss-shape-square{ border-radius: 0; }
    .social-media.ss-shape-circle{ aspect-ratio: 1 / 1; border-radius: 999px; }

    .social-cta{ display:flex; justify-content:center; margin-top: 18px; }
    .social-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 12px 18px;
      border-radius: 999px;
      font-weight: 900;
      background: #16A34A;
      color: #fff;
      text-decoration:none;
      box-shadow: 0 14px 30px rgba(0,0,0,0.14);
      min-width: 160px;
    }
  </style>
</BaseLayout>
