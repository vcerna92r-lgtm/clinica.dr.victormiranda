---
import BaseLayout from "../layouts/BaseLayout.astro";
import site from "../content/site.json";
import home from "../content/home.json";
import homeServices from "../content/home_services.json";
import complications from "../content/home_complications.json";

const siteName = site.clinic_name || site.name || "Cl√≠nica Dr. V√≠ctor Miranda";
const bookingUrl = String(site.booking_url || "").trim() || "/contacto/";

const whatsappNum = String(site.whatsapp || "").trim();
const whatsappMessage = encodeURIComponent(String(site.whatsapp_message || "").trim() || "Hola, quiero agendar una valoraci√≥n.");
const whatsappUrl = whatsappNum ? `https://wa.me/${whatsappNum}?text=${whatsappMessage}` : "https://wa.me/50587355501";

function resolveImageSrc(src) {
  let s = String(src || "").trim();
  if (!s) return "";
  if (s.startsWith("http://") || s.startsWith("https://")) return s;
  if (s.startsWith("public/")) s = s.replace(/^public\//, "");
  if (!s.startsWith("/")) s = `/${s}`;
  return s;
}

function resolveUrl(url, fallback) {
  const u = String(url || "").trim();
  return u ? u : fallback;
}

function fontClass(v) {
  return String(v || "system") === "serif" ? "font-serif" : "font-system";
}
function titleSizeClass(v) {
  const s = String(v || "xl");
  if (s === "md") return "title-md";
  if (s === "lg") return "title-lg";
  return "title-xl";
}
function textSizeClass(v) {
  const s = String(v || "md");
  if (s === "sm") return "text-sm";
  if (s === "lg") return "text-lg";
  return "text-md";
}

/* Servicios principales */
function shapeClass(shape) {
  const s = String(shape || "rounded").toLowerCase();
  if (s === "circle") return "hs-shape-circle";
  if (s === "square") return "hs-shape-square";
  return "hs-shape-rounded";
}

/* Complicaciones */
function compShapeClass(shape) {
  const s = String(shape || "rounded").toLowerCase();
  if (s === "circle") return "comp-shape-circle";
  if (s === "square") return "comp-shape-square";
  return "comp-shape-rounded";
}
function compRatioClass(ratio) {
  const r = String(ratio || "landscape").toLowerCase();
  if (r === "portrait") return "comp-ratio-portrait";
  if (r === "square") return "comp-ratio-square";
  return "comp-ratio-landscape";
}

const marqueeOn = complications.marquee_enabled !== false;
const marqueeBase = String(complications.marquee_text || complications.title || "Manejo de complicaciones").trim();
const marqueeRepeat = Array(8).fill(marqueeBase).join(" ‚ú∂ ") + " ‚ú∂ ";
const marqueeSpeed = String(complications.marquee_speed || "normal");
const marqueeDuration = marqueeSpeed === "fast" ? 12 : marqueeSpeed === "slow" ? 28 : 18;

const compAlign = String(complications.text_align || "left");
const compBold = !!complications.text_bold;
const compItalic = !!complications.text_italic;
---

<BaseLayout
  title={`${siteName} | Medicina est√©tica`}
  description="Tratamientos personalizados con enfoque en seguridad, naturalidad y seguimiento cl√≠nico."
>
  <!-- PORTADA -->
  <section class="cover">
    <div class="cover-grid">
      <div class="cover-photo">
        {home.hero_image ? (
          <img src={resolveImageSrc(home.hero_image)} alt={home.hero_title || siteName} loading="lazy" />
        ) : (
          <div class="photo-placeholder" aria-hidden="true"></div>
        )}
      </div>

      <div class={`cover-copy ${fontClass(home.hero_font_family)} ${textSizeClass(home.hero_text_size)}`}>
        <h1 class={titleSizeClass(home.hero_title_size)}>{home.hero_title || "Tu nombre"}</h1>

        {home.hero_bullets?.length ? (
          <ul class="bullets">
            {home.hero_bullets.map((b) => <li>{b.text}</li>)}
          </ul>
        ) : null}

        {home.hero_paragraphs?.map((p) => <p class="para">{p.text}</p>)}
      </div>
    </div>
  </section>

  <!-- Servicios principales -->
  <section class="section">
    <div class="section-title">
      <div>
        <h2>{homeServices.section_title || "Servicios principales"}</h2>
        {homeServices.section_subtitle && <p class="sub">{homeServices.section_subtitle}</p>}
      </div>
      <a class="link" href="/servicios/">Ver todos ‚Üí</a>
    </div>

    <div class="home-services-grid">
      {homeServices.items?.map((item) => (
        <article class="home-service-card">
          <div class={`home-service-media ${shapeClass(item.image_shape)}`}>
            {item.image ? (
              <img src={resolveImageSrc(item.image)} alt={item.name || "Servicio"} loading="lazy" />
            ) : (
              <div class="media-placeholder" aria-hidden="true"></div>
            )}
          </div>

          <div class="home-service-body">
            <h3>{item.name}</h3>
            {item.description && <p>{item.description}</p>}
          </div>
        </article>
      ))}
    </div>
  </section>

  <!-- Manejo de complicaciones: estilo video + imagen derecha -->
  <section class="section">
    {marqueeOn ? (
      <div class="comp-marquee" style={`--marqueeDuration:${marqueeDuration}s`}>
        <div class="comp-marquee-track" aria-hidden="true">
          <div class="comp-marquee-seq">{marqueeRepeat}</div>
          <div class="comp-marquee-seq" aria-hidden="true">{marqueeRepeat}</div>
        </div>
      </div>
    ) : null}

    <div class="comp-grid">
      <div
        class={`comp-left ${fontClass(complications.font_family)} ${textSizeClass(complications.text_size)} ${compBold ? "comp-bold" : ""} ${compItalic ? "comp-italic" : ""}`}
        style={`text-align:${compAlign};`}
      >
        {complications.eyebrow && <div class="comp-eyebrow">{complications.eyebrow}</div>}
        <h2 class="comp-title">{complications.title || "Manejo de complicaciones"}</h2>
        {complications.subtitle && <p class="comp-sub">{complications.subtitle}</p>}

        {complications.bullets?.length ? (
          <div class="comp-bullets">
            {complications.bullets_title && <div class="comp-bullets-title">{complications.bullets_title}</div>}
            <ul class="comp-bullets-list">
              {complications.bullets.map((it) => <li>{it.text}</li>)}
            </ul>
          </div>
        ) : null}

        <div class="price-card">
          <div class="price-head">
            <div>
              <div class="plan-name">{complications.plan?.name || "Evaluaci√≥n de complicaciones"}</div>
              <div class="plan-price">{complications.plan?.price || "$0.00"}</div>
              {complications.plan?.period && <div class="plan-period">{complications.plan.period}</div>}
            </div>

            <a class="plan-btn" href={resolveUrl(complications.plan?.cta_url, bookingUrl)} target="_blank" rel="noreferrer">
              {complications.plan?.cta_text || "Solicitar evaluaci√≥n"}
            </a>
          </div>

          {complications.includes?.length ? (
            <div class="price-includes">
              <div class="includes-title">{complications.includes_title || "Incluye"}</div>
              <ul class="includes-list">
                {complications.includes.map((it) => <li>{it.text}</li>)}
              </ul>
            </div>
          ) : null}
        </div>

        <div class="comp-box">
          {complications.box_title && <strong>{complications.box_title}</strong>}
          {complications.box_text && <p>{complications.box_text}</p>}

          {complications.box_bullets?.length ? (
            <ul class="comp-box-bullets">
              {complications.box_bullets.map((it) => <li>{it.text}</li>)}
            </ul>
          ) : null}
        </div>
      </div>

      <div class={`comp-right ${compShapeClass(complications.image_shape)} ${compRatioClass(complications.image_ratio)}`}>
        {complications.image ? (
          <img src={resolveImageSrc(complications.image)} alt={complications.title || "Manejo de complicaciones"} loading="lazy" />
        ) : (
          <div class="comp-placeholder" aria-hidden="true"></div>
        )}
      </div>
    </div>
  </section>

  <!-- Testimonios -->
  <section class="section">
    <div class="section-title">
      <div>
        <h2>Testimonios</h2>
        <p class="sub">Puedes reemplazar esto luego por testimonios reales.</p>
      </div>
    </div>

    <div class="grid">
      <div class="card col-4">
        <h3>‚ÄúResultados naturales‚Äù</h3>
        <p>Me encant√≥ que se viera sutil y armonioso.</p>
      </div>
      <div class="card col-4">
        <h3>‚ÄúAtenci√≥n y seguimiento‚Äù</h3>
        <p>Me explicaron todo con claridad y me sent√≠ segura/o.</p>
      </div>
      <div class="card col-4">
        <h3>‚ÄúProfesional y cuidadoso‚Äù</h3>
        <p>Se nota el enfoque m√©dico y la seguridad.</p>
      </div>
    </div>
  </section>

  <!-- CTA final -->
  <section class="section">
    <div class="card soft">
      <h2 style="margin:0 0 8px;">¬øListo para tu valoraci√≥n?</h2>
      <p class="sub">Agenda o escr√≠benos por WhatsApp. Respuesta r√°pida.</p>
      <div class="row" style="margin-top:12px;">
        <a class="btn btn-primary" href={bookingUrl}>Reservar</a>
        <a class="btn" href={whatsappUrl} target="_blank" rel="noreferrer">üí¨ WhatsApp</a>
      </div>
    </div>
  </section>

  <style>
    /* PORTADA */
    .cover{ padding-top: 26px; padding-bottom: 10px; }
    .cover-grid{ display: grid; grid-template-columns: 0.95fr 1.05fr; gap: 22px; align-items: center; }
    .cover-photo{
      width: min(560px, 78vw);
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255,255,255,0.35);
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 16px 40px rgba(15,23,42,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cover-photo img{ width: 100%; height: 100%; object-fit: cover; display:block; }
    .photo-placeholder{
      width: 100%;
      height: 100%;
      background:
        radial-gradient(500px 240px at 20% 20%, rgba(255,255,255,0.70), rgba(255,255,255,0)),
        linear-gradient(135deg, rgba(255,255,255,0.55), rgba(0,0,0,0.05));
      border: 1px dashed rgba(0,0,0,0.12);
    }
    .font-system{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .font-serif{ font-family: ui-serif, Georgia, "Times New Roman", Times, serif; }
    .title-xl{ font-size: 44px; letter-spacing: -0.6px; margin: 0 0 10px; line-height: 1.05; }
    .title-lg{ font-size: 38px; letter-spacing: -0.5px; margin: 0 0 10px; line-height: 1.1; }
    .title-md{ font-size: 32px; letter-spacing: -0.4px; margin: 0 0 10px; line-height: 1.15; }
    .text-lg{ font-size: 18px; }
    .text-md{ font-size: 16px; }
    .text-sm{ font-size: 14px; }
    .bullets{ margin: 0 0 12px; padding-left: 18px; line-height: 1.6; }
    .para{ margin: 10px 0 0; line-height: 1.65; opacity: 0.92; }
    @media (max-width: 980px){
      .cover-grid{ grid-template-columns: 1fr; }
      .cover-photo{ width: min(520px, 85vw); margin: 0 auto; }
    }

    /* Servicios principales */
    .home-services-grid{ display: grid; gap: 18px; grid-template-columns: repeat(12, 1fr); }
    .home-service-card{
      grid-column: span 4;
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 16px 40px rgba(15,23,42,0.06);
      background: #F5F5F2;
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }
    .home-service-media{
      width: 100%;
      aspect-ratio: 16 / 10;
      overflow: hidden;
      padding: 14px;
      background: rgba(255,255,255,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .home-service-media img{ width: 100%; height: 100%; object-fit: cover; border-radius: 16px; display: block; }
    .home-service-body{ padding: 14px 16px 16px; display:flex; flex-direction: column; gap: 8px; }
    .home-service-body h3{ margin: 0; font-size: 18px; letter-spacing: -0.2px; }
    .home-service-body p{ margin: 0; line-height: 1.5; opacity: 0.9; }
    .home-service-media .media-placeholder{ width: 100%; height: 100%; border-radius: 16px; }
    .home-service-media.hs-shape-square img, .home-service-media.hs-shape-square .media-placeholder{ border-radius: 0; }
    .home-service-media.hs-shape-rounded img, .home-service-media.hs-shape-rounded .media-placeholder{ border-radius: 16px; }
    .home-service-media.hs-shape-circle{ aspect-ratio: 1 / 1; padding: 18px; }
    .home-service-media.hs-shape-circle img, .home-service-media.hs-shape-circle .media-placeholder{ border-radius: 999px; }
    @media (max-width: 980px){ .home-service-card{ grid-column: span 6; } }
    @media (max-width: 640px){ .home-service-card{ grid-column: span 12; } }

    /* Complicaciones: marquee */
    .comp-marquee{
      overflow: hidden;
      white-space: nowrap;
      margin-bottom: 12px;
    }
    .comp-marquee-track{
      display: flex;
      width: max-content;
      animation: compMarquee var(--marqueeDuration, 18s) linear infinite;
    }
    .comp-marquee-seq{
      font-size: 26px;
      font-weight: 900;
      letter-spacing: -0.2px;
      padding-right: 22px;
    }
    @keyframes compMarquee{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-50%); }
    }

    /* Complicaciones: layout + estilos */
    .comp-grid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap: 22px;
      align-items: start;
    }

    .comp-eyebrow{ font-weight: 800; opacity: 0.75; margin-bottom: 8px; }
    .comp-title{ margin: 0; font-size: 28px; letter-spacing: -0.2px; }
    .comp-sub{ margin: 10px 0 0; line-height: 1.6; opacity: 0.9; }

    .comp-bold .comp-sub,
    .comp-bold .comp-box p,
    .comp-bold .comp-bullets-list,
    .comp-bold .comp-box-bullets{ font-weight: 700; }

    .comp-italic .comp-sub,
    .comp-italic .comp-box p{ font-style: italic; }

    .comp-bullets{ margin-top: 12px; }
    .comp-bullets-title{ font-weight: 900; margin-bottom: 6px; }
    .comp-bullets-list{ margin: 0; padding-left: 18px; line-height: 1.6; opacity: 0.92; }

    .price-card{
      margin-top: 16px;
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 18px;
      background: #fff;
      box-shadow: 0 16px 40px rgba(15,23,42,0.06);
      overflow: hidden;
    }
    .price-head{ padding: 14px 16px; display:flex; align-items: center; justify-content: space-between; gap: 12px; }
    .plan-name{ font-weight: 900; }
    .plan-price{ font-size: 22px; font-weight: 900; margin-top: 2px; }
    .plan-period{ font-size: 12px; opacity: 0.7; margin-top: 2px; }
    .plan-btn{
      display:inline-flex; align-items:center; justify-content:center;
      height: 40px; padding: 0 14px; border-radius: 999px;
      font-weight: 900; text-decoration: none;
      background: #16A34A; color: #fff;
      box-shadow: 0 10px 24px rgba(0,0,0,0.12);
      white-space: nowrap;
    }
    .price-includes{ border-top: 1px solid rgba(0,0,0,0.08); padding: 12px 16px 14px; }
    .includes-title{ font-weight: 900; margin-bottom: 8px; }
    .includes-list{ margin: 0; padding-left: 18px; line-height: 1.6; opacity: 0.9; }

    .comp-box{
      margin-top: 14px;
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 18px;
      background: #F5F5F2;
      padding: 14px 16px;
      box-shadow: 0 16px 40px rgba(15,23,42,0.04);
    }
    .comp-box p{ margin: 8px 0 0; line-height: 1.6; opacity: 0.9; }
    .comp-box-bullets{ margin: 10px 0 0; padding-left: 18px; line-height: 1.6; opacity: 0.92; }

    .comp-right{
      width: 100%;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 16px 40px rgba(15,23,42,0.06);
      background: rgba(255,255,255,0.35);
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .comp-right.comp-ratio-landscape{ aspect-ratio: 4 / 3; }
    .comp-right.comp-ratio-square{ aspect-ratio: 1 / 1; }
    .comp-right.comp-ratio-portrait{ aspect-ratio: 3 / 4; }

    .comp-right img{ width:100%; height:100%; object-fit: cover; border-radius: 16px; display:block; }
    .comp-placeholder{
      width:100%; height:100%;
      border-radius: 16px;
      background:
        radial-gradient(500px 240px at 20% 20%, rgba(255,255,255,0.70), rgba(255,255,255,0)),
        linear-gradient(135deg, rgba(255,255,255,0.55), rgba(0,0,0,0.05));
      border: 1px dashed rgba(0,0,0,0.12);
    }

    .comp-right.comp-shape-square img,
    .comp-right.comp-shape-square .comp-placeholder{ border-radius: 0; }

    .comp-right.comp-shape-rounded img,
    .comp-right.comp-shape-rounded .comp-placeholder{ border-radius: 16px; }

    .comp-right.comp-shape-circle{
      aspect-ratio: 1 / 1;
      padding: 18px;
    }
    .comp-right.comp-shape-circle img,
    .comp-right.comp-shape-circle .comp-placeholder{ border-radius: 999px; }

    @media (max-width: 980px){
      .comp-grid{ grid-template-columns: 1fr; }
      .comp-marquee-seq{ font-size: 22px; }
    }
  </style>
</BaseLayout>
